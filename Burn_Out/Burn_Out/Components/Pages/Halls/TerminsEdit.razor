@page "/Termins/Edit"

@using Application.Services
@using Core.Models
@using Infrastructure.Repositories
@using Microsoft.EntityFrameworkCore
@using Infrastructure.Data
@using System.ComponentModel.DataAnnotations
@using Core.Interfaces

@inject ISnackbar Snackbar
@inject ApplicationDbContext DbContext
@inject ITerminsRepository TerminsRepo

<AuthorizeView Roles="Employee,Admin">
    <Authorized>
        <MudPaper>
            <MudGrid>
                <MudTable Items="@Termins">
                    <HeaderContent>
                        <MudTh>Początek</MudTh>
                        <MudTh>Koniec</MudTh>
                        <MudTh>Dostępny</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate Context="termin">
                        <MudTd>@termin.StartTime</MudTd>
                        <MudTd>@termin.EndTime</MudTd>
                        <MudTd>@(termin.IsReserved ? "Nie" : "Tak")</MudTd>
                        <MudTd>
                            <MudButton Variant="Variant.Filled" OnClick="() => DeleteTermin(termin.Id)">Usuń</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
                <MudItem>
                    <MudItem>
                        <MudText>Godzina Początkowa</MudText>
                        <input @bind="Input.StartTime" type="time" class="form-control" step="900" />
                    </MudItem>
                    <MudItem>
                        <MudText>Godzina Końcowa</MudText>
                        <input @bind="Input.EndTime" type="time" class="form-control" step="900" />
                    </MudItem>

                    <MudButton Disabled="@_saving" OnClick="@AddTerminAsync">Dodaj</MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </Authorized>
    <NotAuthorized>
        <MudPaper Class="pa-4">
            <MudText>Brak uprawnień.</MudText>
        </MudPaper>
    </NotAuthorized>
</AuthorizeView>

@code {
    private List<TerminsModel> Termins = new List<TerminsModel>();

    private InputModel Input = new InputModel();

    private DateOnly SelectedDate = DateOnly.FromDateTime(DateTime.Today);

    private bool _loading = true;
    private bool _saving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTermins();
    }

    private async Task LoadTermins()
    {
        _loading = true;
        try
        {
            Termins = await DbContext.Termins
                        .Where(t => t.Date == SelectedDate)
                        .OrderBy(t => t.StartTime)
                        .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Wystąpił błąd podczas ładowania terminów: " + ex.Message);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task AddTerminAsync()
    {
        if (Input == null)
        {
            Snackbar.Add("Wprowadź godziny początkową i końcową.", Severity.Error);
            return;
        }

        if (Input.EndTime <= Input.StartTime)
        {
            Snackbar.Add("Godzina końcowa musi być po godzinie początkowej.", Severity.Error);
            return;
        }

        _saving = true;
        try
        {
            var newTermin = new TerminsModel
            {
                Date = SelectedDate,
                StartTime = Input.StartTime,
                EndTime = Input.EndTime,
                IsReserved = false
            };

            await TerminsRepo.AddTerminAsync(newTermin);

            Snackbar.Add("Termin dodany!", Severity.Success);

            await LoadTermins();

            // Optionally reset input
            Input.StartTime = default;
            Input.EndTime = default;
        }
        catch (Exception ex)
        {
            Snackbar.Add("Błąd dodawania terminu: " + ex.Message, Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task DeleteTermin(int Id)
    {
        try
        {
            await TerminsRepo.DeleteTerminAsync(Id);
            Snackbar.Add("Termin usunięty.", Severity.Success);
            await LoadTermins();
        }
        catch (Exception ex)
        {
            Snackbar.Add("Błąd usuwania terminu: " + ex.Message, Severity.Error);
        }
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Data początkowa jest wymagana.")]
        [Display(Name = "Data początkowa")]
        public TimeOnly StartTime { get; set; }

        [Required(ErrorMessage = "Data końcowa jest wymagana.")]
        [Display(Name = "Data końcowa")]
        public TimeOnly EndTime { get; set; }

    }

}
