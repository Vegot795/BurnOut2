@page "/login"
@rendermode InteractiveServer

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav
@using Infrastructure.Models
@using Microsoft.AspNetCore.Identity
@using MudBlazor

<PageTitle>Login</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-10">
    <MudPaper Elevation="4" Class="pa-6">

        <MudText Typo="Typo.h5" Class="mb-4">
            Sign in
        </MudText>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-3">
                @errorMessage
            </MudAlert>
        }

        <MudTextField Label="Email"
                      @bind-Value="email"
                      InputType="InputType.Email"
                      Required="true"
                      Class="mb-3" />

        <MudTextField Label="Password"
                      @bind-Value="password"
                      InputType="InputType.Password"
                      Required="true"
                      Class="mb-4" />

        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   FullWidth="true"
                   OnClick="LoginLogic">
            Login
        </MudButton>

    </MudPaper>
</MudContainer>

@code {
    private string email;
    private string password;
    private string errorMessage;

    async Task LoginLogic()
    {
        if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Email and password are required.";
            return;
        }

        var userExists = UserManager.FindByEmailAsync(email);

        if (userExists == null)
        {
            errorMessage = "Użytkownik nie istnieje";
            return;
        }

        var passwordValid = await UserManager.CheckPasswordAsync(await userExists, password);

        if (!passwordValid)
        {
            errorMessage = "Nieprawidłowe hasło";
            return;
        }

        var url =
            $"/auth/login?Email={Uri.EscapeDataString(email)}&Password={Uri.EscapeDataString(password)}";

        Nav.NavigateTo(url, forceLoad: true);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoginLogic();
        }
    }
}
