@page "/user-profile"
@page "/user-profile/{UserId}"

@using System.ComponentModel.DataAnnotations
@using Burn_Out.Components.Account
@using Infrastructure
@using Infrastructure.Data
@using Infrastructure.Models
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Core.Models
@using Microsoft.EntityFrameworkCore

@attribute [Authorize]

@inject ApplicationDbContext DbContext
@inject UserManager<ApplicationUser> UserManager
@inject IdentityUserAccessor UserAccessor
@inject NavigationManager NavigationManager


<PageTitle>Informacje konta</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" GutterBottom="true">Informacje o koncie</MudText>
        
        @if (isLoading)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        }
        else if (user == null)
        {
            <MudAlert Severity="Severity.Error">Unable to load user data.</MudAlert>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" sm="6" md="4">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Informacje cz³onka</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Imiê: </MudText>
                                    <MudText Typo="Typo.body1">@(user.FirstName ?? "Not provided")</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Nazwisko: </MudText>
                                    <MudText Typo="Typo.body1">@(user.LastName ?? "Not provided")</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Data urodzenia: </MudText>
                                    <MudText Typo="Typo.body1">@(user.DateOfBirth?.ToString("MMMM dd, yyyy") ?? "Not provided")</MudText>
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Cz³onek od: </MudText>
                                    <MudText Typo="Typo.body1">@user.CreatedAt.ToString("MMMM dd, yyyy 'at' hh:mm tt")</MudText>
                                </div>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                
                <MudItem xs="12" sm="6" md="4">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">Kontakt</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudStack Spacing="3">
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                                    <MudText Typo="Typo.body1">@user.Email</MudText>
                                    @if (!user.EmailConfirmed)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Nie potwierdzony</MudChip>
                                    }
                                </div>
                                <div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Numer telefonu</MudText>
                                    <MudText Typo="Typo.body1">@(user.PhoneNumber ?? "Not provided")</MudText>
                                    @if (!string.IsNullOrEmpty(user.PhoneNumber) && !user.PhoneNumberConfirmed)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">Nie potwierdzony</MudChip>
                                    }
                                </div>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12">
                        @if (latestMeasurement != null)
                        {
                        <MudCard>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6">Najnowszy postêp</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudCardContent>
                                <MudStack Row="true" Spacing="6">
                                    <MudGrid>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Martwy ci¹g</MudText>
                                            <MudText>@latestMeasurement?.MaxDeadLift?.ToString()</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Wyciskanie na ³awce</MudText>
                                            <MudText>@latestMeasurement?.MaxBenchPress?.ToString()</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Przysiady</MudText>
                                            <MudText>@latestMeasurement?.MaxSquat?.ToString()</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Szerokoœæ pleców</MudText>
                                            <MudText>@latestMeasurement?.BackWide?.ToString()</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Obwód bicepsu</MudText>
                                            <MudText>@latestMeasurement?.BicepsCircumference?.ToString()</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Obwó uda</MudText>
                                            <MudText>@latestMeasurement?.ThighCircumference?.ToString()</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Obwód klatki piersiowej</MudText>
                                            <MudText>@latestMeasurement?.ChestCircumference?.ToString()</MudText>
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="3">
                                            <MudText>Obwód brzucha</MudText>
                                            <MudText>@latestMeasurement?.BellyCircumference?.ToString()</MudText>
                                        </MudItem>
                                    </MudGrid>
                                </MudStack>
                            </MudCardContent>
                        </MudCard>
                        }
                </MudItem>

                <MudItem xs="12">
                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                        @if (canEdit)
                        {
                            <MudButton Variant="Variant.Filled" 
                                       Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.Edit"
                                       Href="@($"/Account/Edit/{user?.Id}")">
                                Edytuj profil
                            </MudButton>
                        }
                    </MudStack>
                </MudItem>
            </MudGrid>
        }
    </MudPaper>
</MudContainer>

@code {
    private Measurement? latestMeasurement;
    private ApplicationUser? user;
    private bool isLoading = true;
    private bool canEdit = false;

    [Parameter]
    public string? UserId { get; set; }

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            var currentUser = await UserAccessor.GetRequiredUserAsync();
            var currentUserRoles = await UserManager.GetRolesAsync(currentUser);

            if (!string.IsNullOrEmpty(UserId) && (currentUserRoles.Contains("Employee") || currentUserRoles.Contains("Admin")))
            {
                user = await UserManager.FindByIdAsync(UserId);
                canEdit = true;
            }
            else
            {
                user = currentUser;
                canEdit = true; // user can always edit their own profile
            }

            if (user != null)
            {
                latestMeasurement = await DbContext.Measurements
                    .Where(m => m.UserId == user.Id)
                    .OrderByDescending(m => m.Date)
                    .FirstOrDefaultAsync();
            }
        }
        catch (Exception)
        {
            user = null;
        }
        finally
        {
            isLoading = false;
        }
    }
}
